# @mapwise/layers — Architecture

> Layer implementations for MapWise mapping engine.

---

## Mission Statement

Provide **stable, composable layer implementations** that:
- Export factory functions returning `LayerDefinition` contracts
- Maintain minimal coupling to MapLibre (only where necessary)
- Support capabilities parsing, validation, and serialization
- Enable extensibility without UI dependencies

---

## Core Invariants (Non-Negotiable)

These rules are **absolute** and must never be violated:

### 1. No UI Components

```
❌ Layers package NEVER imports:
   - react, vue, svelte, or any UI framework
   - shadcn, radix, headless-ui, or any component library
   - tailwind, styled-components, or any CSS-in-JS
```

Layers are headless - they define map behavior, not UI.

### 2. Minimal MapLibre Coupling

Layers should only couple to MapLibre where necessary for applying sources/layers:

```typescript
// ✅ Minimal coupling - only import types
import type { LayerSpecification, SourceSpecification } from "maplibre-gl";

// ✅ Coupling only for applying sources/layers
function applySource(map: MapLibreMap, source: SourceSpecification) {
  map.addSource(sourceId, source);
}

// ❌ Avoid unnecessary MapLibre dependencies
// Don't import MapLibre utilities unless truly needed
```

### 3. Factory Pattern

Each layer type exports a factory function:

```typescript
export function createWmsLayer(config: WmsLayerConfig): LayerDefinition {
  return {
    id: config.id,
    type: "wms-raster",
    // ... implementation
  };
}
```

Factories return `LayerDefinition` objects that conform to the `@mapwise/core` contract.

### 4. Layer Contracts

Every layer must implement the `LayerDefinition` contract:

#### Required Fields

- `id: string` - Stable, user-provided layer identifier
- `type: string` - Layer kind (e.g., `"wms-raster"`, `"geojson-points"`)
- `apply(map, ctx)` - Apply layer to map (for CustomLayerDefinition)
- `remove(map, ctx)` - Remove layer from map (for CustomLayerDefinition)
- OR `layers: LayerSpecification[]` - MapLibre layer specs (for MapLibreLayerDefinition)

#### Optional Fields

- `category?: LayerCategory` - Z-order grouping (`"base" | "overlay" | "annotation"`)
- `metadata?: LayerMetadata` - Title, description, attribution, etc.
- `source?: SourceDefinition` - Source if layer needs its own
- `getPersistedConfig?()` - Serialization hook (returns config object)
- `setVisibility?(ctx, visible)` - Visibility control (optional)
- `setOpacity?(ctx, opacity)` - Opacity control (optional)

### 5. Layer ID Stability

Layer IDs are:
- **User-provided** - Not generated by the factory
- **Stable** - Same ID across sessions represents the same logical layer
- **Unique** - Uniqueness enforced by `@mapwise/core` registry

```typescript
// ✅ Correct - ID provided by user
createWmsLayer({ id: "my-wms-layer", url: "..." });

// ❌ Wrong - Don't generate IDs
createWmsLayer({ url: "..." }); // Missing ID
```

### 6. Layer Kind Strings

Every layer has a `type` string that identifies its kind:

```typescript
// Standard layer kinds
"wms-raster"
"wmts-raster"
"geojson-points"
"geojson-lines"
"geojson-polygons"
"vectortile"
"pmtiles"
"xyz-raster"
"terrain"
"buildings3d"
```

Kind strings are opaque - used for categorization and filtering, not logic.

### 7. State Serialization

Layers should support state serialization via `getPersistedConfig()`:

```typescript
export interface SerializableLayer {
  getPersistedConfig(): unknown;
  // Called when serializing map state
}

// Implementation
const layer: CustomLayerDefinition = {
  // ...
  getPersistedConfig() {
    return {
      id: this.id,
      type: "wms-raster",
      url: this.config.url,
      layers: this.config.layers,
      // ... other serializable config
    };
  },
};
```

---

## Layer Structure

Each layer type follows this structure:

```
src/
  <layer-type>/
    <layer-type>-layer.ts    # Main factory function
    types.ts                  # Layer-specific types
    <helpers>.ts              # Optional helper functions
    capabilities/             # Optional capabilities support
      fetch-capabilities.ts
      parse-capabilities.ts
      <layer-type>-types.ts
```

### Example: WMS Layer

```typescript
// src/wms/wms-layer.ts
import type { WmsLayerConfig } from "./types";
import type { LayerDefinition } from "@mapwise/core";

export function createWmsLayer(config: WmsLayerConfig): LayerDefinition {
  // Validate config
  validateWmsConfig(config);

  // Return LayerDefinition
  return {
    id: config.id,
    type: "wms-raster",
    category: config.category ?? "overlay",
    metadata: {
      title: config.title,
      attribution: config.attribution,
      // ...
    },
    // MapLibre-based implementation
    source: {
      id: `${config.id}-source`,
      spec: {
        type: "raster",
        tiles: generateWmsTiles(config),
        // ...
      },
    },
    layers: [
      {
        id: `${config.id}-layer`,
        type: "raster",
        source: `${config.id}-source`,
        // ...
      },
    ],
  };
}
```

---

## Shared Utilities

### BaseLayerConfig

All layer configs extend `BaseLayerConfig`:

```typescript
import type { BaseLayerConfig } from "../shared/types";

export interface WmsLayerConfig extends BaseLayerConfig {
  url: string;
  layers: string;
  // ... WMS-specific fields
}
```

### Validation

Use shared validation utilities:

```typescript
import { validateBaseLayerConfig } from "../shared/validation";

export function validateWmsConfig(config: unknown): void {
  const baseResult = validateBaseLayerConfig(config);
  if (!baseResult.valid) {
    throw new Error(`Invalid config: ${baseResult.errors[0]?.message}`);
  }

  // Additional WMS-specific validation
  const wmsConfig = config as WmsLayerConfig;
  if (!wmsConfig.url) {
    throw new Error("WMS URL is required");
  }
  // ...
}
```

---

## Implementing New Layers

To add a new layer type:

1. **Create folder structure**
   ```bash
   src/<new-layer-type>/
     <new-layer-type>-layer.ts
     types.ts
   ```

2. **Define config types**
   ```typescript
   // types.ts
   import type { BaseLayerConfig } from "../shared/types";

   export interface NewLayerConfig extends BaseLayerConfig {
     // Layer-specific fields
   }
   ```

3. **Implement factory**
   ```typescript
   // new-layer-layer.ts
   import type { LayerDefinition } from "@mapwise/core";
   import type { NewLayerConfig } from "./types";

   export function createNewLayer(config: NewLayerConfig): LayerDefinition {
     // Validate
     // Return LayerDefinition
   }
   ```

4. **Export from index.ts**
   ```typescript
   export { createNewLayer } from "./new-layer/new-layer-layer";
   export type { NewLayerConfig } from "./new-layer/types";
   ```

5. **Add tests** (optional in Phase 0, required for Phase 1+)

---

## Capabilities Support

Layers that support capabilities (WMS, WMTS) should:

1. **Fetch capabilities**
   ```typescript
   // capabilities/fetch-capabilities.ts
   export async function fetchWmsCapabilities(url: string): Promise<Document> {
     // Fetch and return XML document
   }
   ```

2. **Parse capabilities**
   ```typescript
   // capabilities/parse-capabilities.ts
   export function parseWmsCapabilities(doc: Document): LayerCapabilities {
     // Parse XML and return structured capabilities
   }
   ```

3. **Export helpers**
   ```typescript
   // wms-layer.ts
   export { fetchWmsCapabilities, parseWmsCapabilities } from "./capabilities";
   ```

---

## Serialization Hooks

Layers can implement serialization hooks for state persistence:

```typescript
interface SerializableLayerDefinition extends CustomLayerDefinition {
  getPersistedConfig(): unknown;
  deserialize?(state: unknown): void;
}
```

When `@mapwise/core` serializes map state, it calls `getPersistedConfig()` on layers that implement it.

When hydrating state, `deserialize()` is called if implemented.

---

## Validation Strategy

### At Factory Boundary

Validate inputs at factory function entry:

```typescript
export function createWmsLayer(config: WmsLayerConfig): LayerDefinition {
  // ✅ Validate here
  const validation = validateWmsConfig(config);
  if (!validation.valid) {
    throw new Error(`Invalid config: ${validation.errors[0]?.message}`);
  }

  // Internal functions trust validated input
  return buildLayerDefinition(config);
}
```

### Validation Utilities

Use shared validation utilities:

- `validateBaseLayerConfig()` - Base layer fields
- `validateLayerId()` - ID format
- `validateOpacity()` - Opacity range
- `validateZoom()` - Zoom levels

Create layer-specific validators as needed.

---

## Error Handling

Layers should:

- **Validate at boundaries** - Throw on invalid config
- **Return structured errors** - Use `LayerValidationError` format
- **Never throw in async contexts** - Emit events instead

```typescript
// ✅ Throw on invalid config (sync, at boundary)
export function createWmsLayer(config: unknown): LayerDefinition {
  const validation = validateWmsConfig(config);
  if (!validation.valid) {
    throw new Error(validation.errors[0]?.message);
  }
  // ...
}

// ❌ Don't throw in async operations
async function fetchCapabilities(url: string) {
  try {
    // ...
  } catch (error) {
    // Emit error event, don't throw
    return null;
  }
}
```

---

## Testing Strategy

### Unit Tests

- Factory functions with valid/invalid configs
- Validation utilities
- Capabilities parsing
- Serialization hooks

### Integration Tests

- Layer registration with `@mapwise/core`
- Style reload behavior
- Visibility/opacity changes
- State persistence round-trip

---

## File Naming Conventions

| Pattern | Purpose | Example |
|---------|---------|---------|
| `kebab-case.ts` | Implementation files | `wms-layer.ts` |
| `kebab-case.ts` | Helper files | `fetch-capabilities.ts` |
| `types.ts` | Type definitions | `types.ts` |
| `PascalCase` | Exports (types) | `WmsLayerConfig` |
| `camelCase` | Exports (functions) | `createWmsLayer` |

---

## Import Rules

### External Dependencies

```typescript
// ✅ Allowed
import type { LayerSpecification, SourceSpecification } from "maplibre-gl";
import type { LayerDefinition } from "@mapwise/core";

// ❌ Forbidden
import React from "react";
import { Button } from "shadcn";
```

### Internal Imports

```typescript
// ✅ Relative imports within layer type
import { validateWmsConfig } from "./validation";

// ✅ Shared utilities
import type { BaseLayerConfig } from "../shared/types";

// ✅ Core types
import type { LayerDefinition } from "@mapwise/core";
```

---

## Phase 0 Deliverables

- ✅ Package foundation (package.json, tsconfig.json)
- ✅ Folder structure for all layer types
- ✅ Shared types (`BaseLayerConfig`, `LayerCapabilities`, `LayerValidationError`)
- ✅ Shared validation utilities
- ✅ `LAYERS_ARCHITECTURE.md` documentation
- ✅ All files build clean with Biome + typecheck

