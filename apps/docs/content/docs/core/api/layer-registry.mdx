---
title: LayerRegistry
description: API for managing map layers.
---

# LayerRegistry

The `LayerRegistry` manages the lifecycle, ordering, and state of map layers. It abstracts away the complexity of keeping MapLibre layers and sources in sync.

Access it via `controller.layers`.

## Methods

### `registerLayer(definition, options?)`

Adds a new layer to the map.

```typescript
controller.layers.registerLayer({
  id: 'my-layer',
  type: 'geojson',
  source: {
    id: 'my-source',
    spec: { type: 'geojson', data: geojsonData }
  },
  layers: [
    { id: 'my-layer-fill', type: 'fill', paint: { 'fill-color': 'red' } }
  ]
});
```

**Parameters:**
- `definition` (`LayerDefinition`): The layer configuration.
- `options` (`object`):
  - `position`: Where to insert the layer (e.g., `{ type: 'top' }`).
  - `visible`: Initial visibility override.
  - `opacity`: Initial opacity override.


---

## Layer Definitions

The `registerLayer` method accepts a `LayerDefinition`, which can be one of two types:

### MapLibre Definition

Standard layers that map directly to MapLibre style layers.

```typescript
interface MapLibreLayerDefinition {
  id: string;
  type: string; // Internal grouping type
  category?: 'base' | 'overlay' | 'annotation';
  source?: SourceDefinition;
  layers: maplibregl.LayerSpecification[]; // Actual MapLibre layers
  metadata?: LayerMetadata;
}
```

### Custom Definition

Layers that require custom lifecycle management (e.g., HTML markers, WebGL overlays).

```typescript
interface CustomLayerDefinition {
  id: string;
  type: string;
  apply: (ctx: LayerHandlerContext) => void | Promise<void>;
  remove: (ctx: LayerHandlerContext) => void | Promise<void>;
  // ... optional lifecycle hooks (setVisibility, setOpacity)
}
```

### Metadata

```typescript
interface LayerMetadata {
  title?: string;
  description?: string;
  attribution?: string;
  initialVisibility?: boolean;
  initialOpacity?: number;
  minZoom?: number;
  maxZoom?: number;
  legend?: unknown;
}
```

---

### `removeLayer(id)`

Removes a layer and its associated sources (if not used by other layers).

```typescript
controller.layers.removeLayer('my-layer');
```

**Returns:** `boolean` (true if removed, false if not found)

---

### `setVisibility(id, visible)`

Toggles layer visibility.

```typescript
controller.layers.setVisibility('my-layer', false);
```

---

### `setOpacity(id, opacity)`

Sets the opacity of the layer (0 to 1). This automatically applies to all sub-layers (fill, stroke, text) in a smart way.

```typescript
controller.layers.setOpacity('my-layer', 0.5);
```

---

### `moveLayer(id, position)`

Moves a layer to a new Z-index position.

```typescript
// Move to top
controller.layers.moveLayer('my-layer', { type: 'top' });

// Move below another layer
controller.layers.moveLayer('my-layer', { 
  type: 'below', 
  layerId: 'labels' 
});
```

---

### `getAllLayers()`

Returns an ordered array of all registered layers and their current state.

```typescript
const allLayers = controller.layers.getAllLayers();
console.log(allLayers.map(l => l.id));
```

### `getLayerState(id)`

Gets the state of a specific layer (visibility, opacity, applied status).

```typescript
const state = controller.layers.getLayerState('my-layer');
if (state?.visible) {
  // ...
}
```

---

### `getLayersByCategory(category)`

Returns a list of layers filtered by a specific category.

```typescript
const overlays = controller.layers.getLayersByCategory('overlay');
```

**Returns:** `LayerState[]`

---

### `hasLayer(id)`

Checks if a layer is registered.

```typescript
if (controller.layers.hasLayer('my-layer')) {
  // ...
}
```

**Returns:** `boolean`

---

### `clear()`

Removes all layers from both the registry and the map.

```typescript
controller.layers.clear();
```

---

### `count`

Returns the number of registered layers.

```typescript
console.log(controller.layers.count);
```

**Type:** `number`

