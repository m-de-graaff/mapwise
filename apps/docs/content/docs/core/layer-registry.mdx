---
title: LayerRegistry
description: Managing map layers declaratively.
---

# LayerRegistry

The `LayerRegistry` manages the lifecycle of layers on the map. It decouples the *intent* to have a layer from the *implementation* of adding it to the specific MapLibre instance.

## Key Features

- **Decoupled State**: Layer state (visibility, opacity) is stored in the registry, not just on the map. This allows state to persist even if the map is destroyed or the style is changed.
- **Batched Updates**: Operations are batched to prevent performance issues.
- **Automatic Re-application**: Layers are automatically removed and re-added when the basemap changes.
- **Ordering**: Layers are strictly ordered z-index style, handled by the registry.

## API Reference

```typescript
interface LayerRegistry {
  // Operations
  registerLayer(def: LayerDefinition, options?: RegisterLayerOptions): void;
  removeLayer(id: string): boolean;
  moveLayer(id: string, position: LayerPosition): boolean;
  
  // State updates
  setVisibility(id: string, visible: boolean): boolean;
  setOpacity(id: string, opacity: number): boolean;
  
  // Queries
  hasLayer(id: string): boolean;
  getLayerState(id: string): LayerState | undefined;
  getAllLayers(): LayerState[];
  getLayersByCategory(category: LayerCategory): LayerState[];
  
  readonly count: number;
}
```

## Layer Definitions

Mapwise supports two types of layer definitions:

### 1. MapLibre Integration (`MapLibreLayerDefinition`)
For standard MapLibre layers (GeoJSON, Raster, Vector Tiles).

```typescript
controller.layers.registerLayer({
  id: 'my-geojson',
  type: 'geojson',
  source: {
    id: 'my-source',
    spec: { type: 'geojson', data: myFeatureCollection }
  },
  layers: [
    {
      id: 'my-geojson-fill',
      type: 'fill',
      source: 'my-source',
      paint: { 'fill-color': 'blue' }
    }
  ],
  metadata: { title: 'My Areas' }
});
```

### 2. Custom Layers (`CustomLayerDefinition`)
For complex logic that needs direct access to the map (e.g., deck.gl integration, custom markers).

```typescript
controller.layers.registerLayer({
  id: 'my-custom-layer',
  type: 'custom',
  apply: async (ctx) => {
    // Custom logic to add layer
  },
  remove: async (ctx) => {
    // Cleanup logic
  }
});
```

## Positioning

When registering or moving a layer, you can specify its position:

```typescript
type LayerPosition = 
  | { type: 'top' }
  | { type: 'bottom' }
  | { type: 'index', index: number }
  | { type: 'above', layerId: string }
  | { type: 'below', layerId: string };
```
